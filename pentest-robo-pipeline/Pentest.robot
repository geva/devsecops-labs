*** Settings ***
Library  Collections
Library  RoboZap  http://127.0.0.1:8090/  8090
Library  RoboNmap
Library  RoboWFuzz  directory-list-1.0.txt
Library  OperatingSystem
Library  REST  http://localhost:3000  proxies={"http": "http://127.0.0.1:8090", "https": "http://127.0.0.1:8090"}

*** Variables ***
${TARGET_NAME}  Altoro Mutual Banking App
${TARGET_URI}  localhost:3000
${TARGET_HOST}  localhost
${TARGET_IP}  localhost
#CONFIG
${RESULTS_PATH}  ${CURDIR}/results

#WFUZZ
${WFUZZ_FILE}  directory_brute.json


#ZAP
${ZAP_PATH}  /root/zap/ZAP_2.7.0/
${APPNAME}  Altoro Mutual Banking App
${CONTEXT}  Altoro_Mutual
${REPORT_TITLE}  Altoro Mutual Banking App Test Report - ZAP
${REPORT_FORMAT}  json
${ZAP_REPORT_FILE}  altoro.json
${REPORT_AUTHOR}  Abhay Bhargav
${SCANPOLICY}  Light

*** Test Cases ***
Setup directories
    Create Directory  ${RESULTS_PATH}

Port Scan and Service Enumeration
    nmap script scan  ${TARGET_HOST}
    nmap print results

Directory Bruteforce
    [Timeout]  30 seconds
    brute directories  http://${TARGET_URI}/FUZZ  concur=3  file_name=${RESULTS_PATH}/${WFUZZ_FILE}

Initialize ZAP
    [Tags]  zap_init
    start headless zap  ${ZAP_PATH}
    sleep  10
    zap open url  http://${TARGET_URI}

Authenticate to Cut the Funds as Admin
    [Tags]  walk_web_service
    &{res}=  POST  /users/login  {"email": "andy.roberts@widget.co", "password": "spiderman"}
    Integer  response status  200
    Boolean  response body auth  true
    set suite variable  ${TOKEN}  ${res.body["token"]}
    log  ${TOKEN}

Search the Currency Lookup Service
    [Tags]  walk_web_service
    [Setup]  Set Headers  { "Authorization": "${TOKEN}" }
    POST  /projects/search_expense_db  { "search": "Chile" }
    Integer  response status  200
    String  $[0].country  Chile

ZAP Contextualize
    [Tags]  zap_context
    ${contextid}=  zap define context  ${CONTEXT}  http://${TARGET_URI}
    set suite variable  ${CONTEXT_ID}  ${contextid}

ZAP Active Scan
    [Tags]  zap_scan
    ${scan_id}=  zap start ascan  ${CONTEXT_ID}  http://${TARGET_URI}  ${SCANPOLICY}
    set suite variable  ${SCAN_ID}  ${scan_id}
    zap scan status  ${scan_id}

ZAP Generate Report
    [Tags]  zap_generate_report
    zap export report  ${RESULTS_PATH}/${ZAP_REPORT_FILE}  ${REPORT_FORMAT}  ${REPORT_TITLE}  ${REPORT_AUTHOR}

ZAP Die
    zap shutdown
